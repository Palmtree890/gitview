<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Repo Explorer & Downloader</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Prism.js for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <style>
      :root {
        --bg-color: #0d1117;
        --card-bg: #161b22;
        --border-color: #30363d;
        --text-primary: #c9d1d9;
        --text-secondary: #8b949e;
        --accent: #238636;
        --accent-hover: #2ea44f;
        --link-color: #58a6ff;
        --lang-bg: #21262d;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        line-height: 1.6;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding-top: 20px;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 20px;
        color: white;
        letter-spacing: -0.5px;
      }

      .mode-toggle {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .mode-btn {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
      }

      .mode-btn.active {
        background: var(--link-color);
        color: white;
        border-color: var(--link-color);
      }

      .search-box {
        display: flex;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        max-width: 600px;
        margin: 0 auto;
        transition: border-color 0.2s;
      }

      .search-box:focus-within {
        border-color: var(--link-color);
      }

      .search-box input {
        flex: 1;
        background: transparent;
        border: none;
        padding: 14px 20px;
        color: white;
        font-size: 1rem;
        outline: none;
      }

      .search-box button {
        background: var(--accent);
        color: white;
        border: none;
        padding: 0 25px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
      }

      .search-box button:hover {
        background: var(--accent-hover);
      }

      #profile-display {
        margin-top: 30px;
        display: none;
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .profile-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 25px;
        margin-bottom: 30px;
      }

      .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
      }

      .user-info h2 { color: white; margin-bottom: 4px; }
      .user-link { color: var(--link-color); text-decoration: none; font-size: 0.9rem; }

      .filter-section {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .repo-filter {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        width: 100%;
        max-width: 300px;
        outline: none;
      }

      .repo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .repo-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: all 0.2s;
        cursor: pointer;
      }

      .repo-card:hover {
        border-color: #8b949e;
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      }

      .repo-title-container {
        display: flex;
        flex-direction: column;
        margin-bottom: 8px;
      }

      .repo-owner {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .repo-title {
        color: var(--link-color);
        font-size: 1.1rem;
        font-weight: 700;
        text-decoration: none;
      }

      .repo-description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 15px;
        min-height: 2.5em;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .repo-meta {
        display: flex;
        gap: 12px;
        margin-bottom: 15px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        align-items: center;
      }

      .lang-tag {
        background: var(--lang-bg);
        padding: 2px 8px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
      }

      .action-btns { display: flex; gap: 8px; }

      .download-link, .view-btn {
        flex: 1;
        background: #21262d;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 8px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
      }

      .view-btn { background: var(--accent); color: white; border: none; }
      .view-btn:hover { background: var(--accent-hover); }
      .download-link:hover { background: #30363d; }

      /* Tree Viewer */
      #tree-viewer { display: none; margin-top: 10px; animation: fadeIn 0.4s ease-out; }
      
      #breadcrumb {
        display: flex; align-items: center; gap: 8px; margin-bottom: 15px;
        padding: 10px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);
        font-size: 0.9rem;
      }
      #breadcrumb span { cursor: pointer; color: var(--link-color); }

      .tree-container { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: 500px; margin-bottom: 30px; }
      #tree-list { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow-y: auto; padding: 10px; }
      #file-preview { 
        background: var(--card-bg); 
        border: 1px solid var(--border-color); 
        border-radius: 12px; 
        overflow: hidden; 
        position: relative; 
      }
      
      .preview-scroll { height: 100%; overflow: auto; padding: 0; display: flex; flex-direction: column; }

      .tree-item {
        display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 6px;
        cursor: pointer; font-size: 0.9rem; transition: background 0.2s;
      }
      .tree-item:hover { background: rgba(255,255,255,0.05); }
      .folder { color: #e3b341; }
      .file { color: var(--text-secondary); }

      /* README Section */
      #readme-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-top: 30px;
        display: none;
      }
      .readme-header {
        padding: 12px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: white;
      }
      #readme-content {
        padding: 30px;
        color: var(--text-primary);
        line-height: 1.6;
      }
      #readme-content h1, #readme-content h2, #readme-content h3 { margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
      #readme-content p { margin-bottom: 16px; }
      #readme-content code { padding: 0.2em 0.4em; background: rgba(110,118,129,0.4); border-radius: 6px; font-family: 'Fira Code', monospace; }
      #readme-content pre { padding: 16px; background: #0d1117; border-radius: 6px; margin-bottom: 16px; overflow: auto; }
      #readme-content pre code { background: transparent; padding: 0; white-space: pre !important; }

      /* ABSOLUTE FIX FOR ONE-LINE CODE BUG */
      #preview-content pre {
        margin: 0 !important;
        padding: 20px !important;
        background: transparent !important;
        overflow: visible !important; /* Managed by parent .preview-scroll */
        width: 100%;
      }

      #preview-content code {
        font-family: 'Fira Code', 'Consolas', monospace !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        white-space: pre !important; /* FORCES LINE BREAKS */
        word-spacing: normal !important;
        word-break: normal !important;
        word-wrap: normal !important;
        display: block !important; /* Ensure it behaves as a block for the pre-formatting */
      }

      img.preview-img { display: block; max-width: 90%; max-height: 90%; margin: auto; border-radius: 8px; }
      .img-container { display: flex; flex: 1; align-items: center; justify-content: center; background: #000; }

      .back-to-grid {
        display: inline-flex; align-items: center; gap: 8px; color: var(--text-secondary);
        cursor: pointer; margin-bottom: 15px; font-weight: 600;
      }
      .back-to-grid:hover { color: white; }

      .loading-spinner { text-align: center; padding: 40px; color: var(--text-secondary); }

      @media (max-width: 800px) {
        .tree-container { grid-template-columns: 1fr; height: auto; }
        #tree-list { height: 250px; }
        #file-preview { height: 400px; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header id="main-header">
        <h1>GitHub Explorer</h1>
        
        <div class="mode-toggle">
          <button id="modeUser" class="mode-btn active">User Mode</button>
          <button id="modeRepo" class="mode-btn">Repo Search Mode</button>
        </div>

        <div class="search-box">
          <input type="text" id="inputSearch" placeholder="Enter GitHub username..." />
          <button id="searchBtn">Search</button>
        </div>
      </header>

      <div id="status"></div>

      <!-- User Profile & Repo Grid -->
      <div id="profile-display">
        <div class="profile-card" id="profile-card" style="display: none;"></div>
        
        <div class="filter-section">
          <h3 id="result-title">Repositories</h3>
          <input type="text" id="repoFilter" class="repo-filter" placeholder="Filter these results..." />
        </div>

        <div class="repo-grid" id="repo-grid"></div>
      </div>

      <!-- Repo Tree Viewer Section -->
      <div id="tree-viewer">
        <div class="back-to-grid" id="closeTree">
          <span class="material-icons">arrow_back</span> Back to Results
        </div>
        <h2 id="viewing-repo-name" style="margin-bottom: 10px; color: white;"></h2>
        <div id="breadcrumb"></div>
        <div class="tree-container">
          <div id="tree-list"></div>
          <div id="file-preview">
            <div class="preview-scroll" id="preview-content">
               <p style="color: var(--text-secondary); text-align: center; margin-top: 100px;">Select a file to preview</p>
            </div>
          </div>
        </div>

        <!-- README section -->
        <div id="readme-container">
          <div class="readme-header">
            <span class="material-icons" style="font-size: 18px;">menu_book</span>
            README.md
          </div>
          <div id="readme-content"></div>
        </div>
      </div>
    </div>

    <!-- Scripts for Prism -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>

    <script>
      const inputSearch = document.getElementById('inputSearch');
      const searchBtn = document.getElementById('searchBtn');
      const profileDisplay = document.getElementById('profile-display');
      const treeViewer = document.getElementById('tree-viewer');
      const profileCard = document.getElementById('profile-card');
      const repoGrid = document.getElementById('repo-grid');
      const statusDiv = document.getElementById('status');
      const repoFilterInput = document.getElementById('repoFilter');
      const closeTree = document.getElementById('closeTree');
      const treeList = document.getElementById('tree-list');
      const previewContent = document.getElementById('preview-content');
      const breadcrumb = document.getElementById('breadcrumb');
      const viewingRepoName = document.getElementById('viewing-repo-name');
      const resultTitle = document.getElementById('result-title');
      const readmeContainer = document.getElementById('readme-container');
      const readmeContent = document.getElementById('readme-content');
      
      const modeUser = document.getElementById('modeUser');
      const modeRepo = document.getElementById('modeRepo');

      let currentRepos = []; 
      let activeRepoPath = "";
      let pathStack = [];
      let searchMode = "user";

      modeUser.onclick = () => {
        searchMode = "user";
        modeUser.classList.add('active');
        modeRepo.classList.remove('active');
        inputSearch.placeholder = "Enter GitHub username...";
      };

      modeRepo.onclick = () => {
        searchMode = "repo";
        modeRepo.classList.add('active');
        modeUser.classList.remove('active');
        inputSearch.placeholder = "Enter repository keywords...";
      };

      const showStatus = (msg) => {
        statusDiv.innerHTML = `<div class="loading-spinner">${msg}</div>`;
      };

      const clearStatus = () => statusDiv.innerHTML = '';

      const performSearch = async () => {
        const query = inputSearch.value.trim();
        if (!query) return;

        showStatus('Connecting to GitHub...');
        profileDisplay.style.display = 'none';
        treeViewer.style.display = 'none';
        profileCard.style.display = 'none';

        try {
          if (searchMode === "user") {
            await fetchUserData(query);
          } else {
            await fetchRepoData(query);
          }
          clearStatus();
          profileDisplay.style.display = 'block';
        } catch (err) {
          showStatus(`<span style="color: #f85149;">Error: ${err.message}</span>`);
        }
      };

      async function fetchUserData(username) {
        const userRes = await fetch(`https://api.github.com/users/${username}`);
        if (!userRes.ok) throw new Error('User not found');
        const userData = await userRes.json();
        const repoRes = await fetch(`https://api.github.com/users/${username}/repos?sort=updated&per_page=100`);
        currentRepos = await repoRes.json();
        displayProfile(userData);
        resultTitle.textContent = `${userData.login}'s Repositories`;
        displayRepos(currentRepos);
      }

      async function fetchRepoData(keywords) {
        const res = await fetch(`https://api.github.com/search/repositories?q=${encodeURIComponent(keywords)}&sort=stars&order=desc`);
        if (!res.ok) throw new Error('Search failed');
        const data = await res.json();
        currentRepos = data.items;
        resultTitle.textContent = `Search Results for "${keywords}"`;
        displayRepos(currentRepos);
      }

      function displayProfile(user) {
        profileCard.style.display = 'flex';
        profileCard.innerHTML = `
          <img src="${user.avatar_url}" class="avatar" alt="${user.login}">
          <div class="user-info">
            <h2>${user.name || user.login}</h2>
            <a href="${user.html_url}" target="_blank" class="user-link">@${user.login}</a>
          </div>
        `;
      }

      function displayRepos(repos) {
        repoGrid.innerHTML = '';
        if (repos.length === 0) {
          repoGrid.innerHTML = '<p style="padding: 20px;">No repositories found.</p>';
          return;
        }

        repos.forEach(repo => {
          const card = document.createElement('div');
          card.className = 'repo-card';
          const downloadUrl = `https://codeload.github.com/${repo.owner.login}/${repo.name}/zip/refs/heads/${repo.default_branch || 'main'}`;
          
          card.innerHTML = `
            <div>
              <div class="repo-title-container">
                <span class="repo-owner">${repo.owner.login} /</span>
                <span class="repo-title">${repo.name}</span>
              </div>
              <p class="repo-description">${repo.description || 'No description provided.'}</p>
              <div class="repo-meta">
                ${repo.language ? `<span class="lang-tag">${repo.language}</span>` : ''}
                <span>‚≠ê ${repo.stargazers_count}</span>
              </div>
            </div>
            <div class="action-btns">
              <button class="view-btn" onclick="openRepoTree('${repo.owner.login}', '${repo.name}')">View Files</button>
              <a href="${downloadUrl}" class="download-link" onclick="event.stopPropagation()">ZIP</a>
            </div>
          `;
          card.onclick = () => openRepoTree(repo.owner.login, repo.name);
          repoGrid.appendChild(card);
        });
      }

      async function openRepoTree(owner, repo) {
        activeRepoPath = `${owner}/${repo}`;
        pathStack = [];
        profileDisplay.style.display = 'none';
        treeViewer.style.display = 'block';
        viewingRepoName.textContent = repo;
        readmeContainer.style.display = 'none';
        previewContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 100px;">Select a file to preview</p>';
        
        await loadPath("");
      }

      async function loadPath(path) {
        treeList.innerHTML = '<p style="padding: 15px; font-size: 0.8rem;">Loading contents...</p>';
        try {
          const res = await fetch(`https://api.github.com/repos/${activeRepoPath}/contents/${path}`);
          const data = await res.json();
          renderTree(data);
          renderBreadcrumb();

          if (path === "") {
            const readmeFile = data.find(f => f.name.toLowerCase() === 'readme.md');
            if (readmeFile) fetchReadme(readmeFile.download_url);
          }
        } catch (e) {
          treeList.innerHTML = '<p style="padding: 15px; color: #f85149;">Failed to load file list.</p>';
        }
      }

      async function fetchReadme(url) {
        try {
          const res = await fetch(url);
          const text = await res.text();
          readmeContent.innerHTML = marked.parse(text);
          readmeContainer.style.display = 'block';
          readmeContent.querySelectorAll('pre code').forEach(block => {
            block.style.whiteSpace = 'pre';
            Prism.highlightElement(block);
          });
        } catch (e) {
          console.error("Failed to load README", e);
        }
      }

      function renderTree(items) {
        treeList.innerHTML = '';
        if (!Array.isArray(items)) return;

        items.sort((a, b) => (b.type === 'dir') - (a.type === 'dir')).forEach(item => {
          const div = document.createElement('div');
          div.className = 'tree-item';
          const icon = item.type === 'dir' ? 'folder' : 'insert_drive_file';
          const iconClass = item.type === 'dir' ? 'folder' : 'file';

          div.innerHTML = `
            <span class="material-icons ${iconClass}">${icon}</span>
            <span>${item.name}</span>
          `;

          div.onclick = () => {
            if (item.type === 'dir') {
              pathStack.push(item.name);
              loadPath(pathStack.join('/'));
            } else {
              previewFile(item);
            }
          };
          treeList.appendChild(div);
        });
      }

      async function previewFile(item) {
        previewContent.innerHTML = '<p style="text-align: center; margin-top: 50px;">Opening file...</p>';
        const ext = item.name.split('.').pop().toLowerCase();
        
        if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext)) {
          previewContent.innerHTML = `<div class="img-container"><img src="${item.download_url}" class="preview-img" alt="${item.name}"></div>`;
        } else {
          try {
            const res = await fetch(item.download_url);
            const text = await res.text();
            
            const langMap = {
              'js': 'javascript', 'py': 'python', 'css': 'css', 'html': 'markup',
              'json': 'json', 'ts': 'typescript', 'md': 'markup', 'sh': 'bash'
            };
            const langClass = langMap[ext] || 'text';
            
            // Re-creating elements to ensure no old styling persists
            previewContent.innerHTML = '';
            const pre = document.createElement('pre');
            pre.className = `language-${langClass}`;
            const code = document.createElement('code');
            code.className = `language-${langClass}`;
            code.textContent = text; // innerText/textContent preserves line breaks
            
            pre.appendChild(code);
            previewContent.appendChild(pre);
            
            Prism.highlightElement(code);
          } catch (e) {
            previewContent.innerHTML = `<p style="color: #f85149; text-align: center; margin-top: 50px;">Could not preview this file.</p>`;
          }
        }
      }

      function renderBreadcrumb() {
        breadcrumb.innerHTML = '';
        const root = document.createElement('span');
        root.textContent = activeRepoPath.split('/')[1];
        root.onclick = () => { pathStack = []; loadPath(""); };
        breadcrumb.appendChild(root);

        pathStack.forEach((seg, i) => {
          const sep = document.createElement('span');
          sep.textContent = ' / ';
          sep.style.color = 'var(--text-secondary)';
          breadcrumb.appendChild(sep);

          const crumb = document.createElement('span');
          crumb.textContent = seg;
          crumb.onclick = () => {
            pathStack = pathStack.slice(0, i + 1);
            loadPath(pathStack.join('/'));
          };
          breadcrumb.appendChild(crumb);
        });
      }

      closeTree.onclick = () => {
        treeViewer.style.display = 'none';
        profileDisplay.style.display = 'block';
      };

      repoFilterInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = currentRepos.filter(repo => 
          repo.name.toLowerCase().includes(term) || 
          (repo.description && repo.description.toLowerCase().includes(term)) ||
          repo.owner.login.toLowerCase().includes(term)
        );
        displayRepos(filtered);
      });

      searchBtn.onclick = performSearch;
      inputSearch.onkeypress = (e) => { if (e.key === 'Enter') performSearch(); };
    </script>
  </body>
</html>